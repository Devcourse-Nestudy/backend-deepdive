### DBCP

- 탄생배경: TCP 기반 통신시 connection을 맺고/끊는 과정이 비용을 많이 소모한다.
- 기본 개념:
  1. 미리 임의의 DB connection 을 생성하고 pool에 저장/관리한다.
  2. 서버는 DB 접근이 필요할 때 pool 에서 connection 을 빌려 사용하고 이후 반납하여 재사용한다.

### DBCP 설정 (HikariCP, Mysql)

### Mysql DB

- **max_connections:DB 서버가 클라이언트와 맺을 수 있는 최대 커넥션 수이다.**
- **wait_timeout**: DB 서버에서 비활성(Inactive) 커넥션을 얼마나 기다리다가 끊을지 결정하는 파라미터이다. 비정상적으로 종료되거나 반환되지 않은 커넥션이 리소스를 점유하는 것을 방지한다.

### HikariCP

- **minimumIdle**: 풀에서 유지할 최소 유휴(Idle) 커넥션 수입니다.
- **maximumPoolSize**: 풀이 가질 수 있는 최대 커넥션 수 (유휴 + 활성 커넥션).
  - **권장 사항**: minimumIdle과 maximumPoolSize 값을 동일하게 설정하여 풀 사이즈를 고정하는 것을 권장한다. 이는 트래픽 급증 시 커넥션을 새로 생성하는 시간 때문에 생기는 응답 지연을 방지하기 위함이다.
- **maxLifetime**: 풀에서 커넥션의 최대 수명이다. 이 시간을 초과하면 idle인 경우 바로 제거하고 active인 경우 pool에 반환되면 제거한다.
  - DB의 wait_timeout보다 maxLifetime을 2~5초 정도 짧게 설정해야 한다. 이는 DB 서버에서 커넥션을 끊기 전에 DBCP가 먼저 커넥션을 제거하도록 하여, 애플리케이션이 중간과정에서 소비되는 시간 때문에 이미 끊어진 커넥션을 사용하려다 발생하는 예외를 방지합니다.
- **connectionTimeout**: DBCP에서 커넥션을 빌려오기 위해 대기하는 최대 시간이다. 요청이 많아 시간 내에 커넥션을 얻지 못하면 예외가 발생합니다.

### **적절한 커넥션 수 찾기**

1. **모니터링 환경 구축**: 백엔드 서버, DB 서버의 CPU, 메모리, 네트워크, 디스크 I/O 등 리소스 사용률을 지속적으로 모니터링
2. **부하 테스트 수행**: 엔그라인더(nGrinder)와 같은 부하 테스트 툴을 사용하여 시스템에 점진적으로 트래픽을 증가킨다.
3. **지표 관찰**:
   - **RPS (Requests Per Second)**: 초당 처리 가능한 요청 수 (전체 처리량).
   - **Average Response Time**: 평균 응답 시간 (API 성능).
   - **리소스 사용률**: 백엔드 서버와 DB 서버의 CPU, 메모리 등 리소스 사용률.
4. **병목 현상 분석**:
   - **CPU/메모리 병목**: 특정 서버의 CPU/메모리 사용률이 임계치를 초과하면 해당 서버를 추가 배포하거나(백엔드), 캐시 레이어 도입, 샤딩, 레플리카 증설 등으로 부하를 분산한다.
   - **스레드 풀 병목**: thread per request 모델의 경우 벡엔드 서버의 스레드 풀에서 모든 스레드가 활성화되어 대기 중이라면, 스레드 풀 사이즈를 늘리는 것을 고려할 수 있다.
   - **DBCP 커넥션 병목**: DBCP의 maximumPoolSize만큼 모든 커넥션이 활성화되어 사용 중이라면, maximumPoolSize를 늘려 확인한다.
     - 사용할 벡엔드 서버 수를 고려하여 DBCP의 maximumPoolSize 를 결정
